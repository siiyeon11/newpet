<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë©”ì´í”ŒìŠ¤í† ë¦¬ ìºë¦­í„° ê²€ìƒ‰ & ì¥ë¹„ ì¡°íšŒ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .api-key-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .api-key-section input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .search-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-box input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .search-box button {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s;
        }

        .search-box button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .search-box button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .character-info {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
        }

        .character-info.active {
            display: block;
        }

        .character-info h2 {
            color: #667eea;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .character-layout {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-top: 20px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
        }

        .info-label {
            font-weight: bold;
            color: #666;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 18px;
            color: #333;
        }

        .equipment-section {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
        }

        .equipment-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .equipment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .equipment-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }

        .equipment-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .equipment-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .equipment-name {
            font-weight: bold;
            color: #333;
            font-size: 1.1em;
        }

        .equipment-part {
            background: #667eea;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.85em;
        }

        .equipment-details {
            margin-top: 10px;
        }

        .equipment-detail-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 0.9em;
        }

        .equipment-detail-label {
            color: #666;
        }

        .equipment-detail-value {
            color: #333;
            font-weight: 500;
        }

        .equipment-stats {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: 0.85em;
        }

        .stat-label {
            color: #666;
        }

        .stat-value {
            color: #667eea;
            font-weight: bold;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            border-left: 4px solid #c33;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .no-equipment {
            text-align: center;
            padding: 40px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ ë©”ì´í”ŒìŠ¤í† ë¦¬ ìºë¦­í„° ê²€ìƒ‰ & ì¥ë¹„ ì¡°íšŒ</h1>
            <p>ë„¥ìŠ¨ Open APIë¥¼ í™œìš©í•œ ìºë¦­í„° ì •ë³´ ë° ì¥ì°© ì•„ì´í…œ ì¡°íšŒ</p>
        </div>

        <!-- í”„ë¡ì‹œ ì„œë²„ ìƒíƒœ í‘œì‹œ -->
        <div id="proxy-status"></div>
        
        <!-- API Key ì…ë ¥ ì˜ì—­ -->
        <div class="api-key-section">
            <label for="api-key" style="display: block; margin-bottom: 10px; font-weight: bold; color: #333;">
                ğŸ”‘ API Key ì…ë ¥
            </label>
            <div style="display: flex; gap: 10px;">
                <input type="password" id="api-key" placeholder="ë„¥ìŠ¨ Open API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”" 
                       onkeypress="if(event.key === 'Enter') saveApiKey()"
                       style="flex: 1;">
                <button onclick="saveApiKey()" id="save-key-btn" style="padding: 12px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">ì €ì¥</button>
            </div>
            <div id="api-key-status" style="margin-top: 10px; font-size: 14px;"></div>
        </div>

        <!-- ìºë¦­í„° ê²€ìƒ‰ ì˜ì—­ -->
        <div class="search-section">
            <h2 style="color: #667eea; margin-bottom: 20px;">ìºë¦­í„° ê²€ìƒ‰</h2>
            <div class="search-box">
                <input type="text" id="character-name" placeholder="ìºë¦­í„° ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" 
                       onkeypress="if(event.key === 'Enter') searchCharacter()">
                <button onclick="searchCharacter()" id="search-btn">ê²€ìƒ‰</button>
            </div>
            <div id="character-info" class="character-info"></div>
        </div>
    </div>

    <script>
        // API ê¸°ë³¸ URL ì„¤ì •
        const PROXY_PORT = 8000;
        const PROXY_URL = `http://localhost:${PROXY_PORT}`;
        const DIRECT_API_BASE_URL = 'https://open.api.nexon.com';
        
        let USE_PROXY = true;
        let API_BASE_URL = PROXY_URL;
        
        // í”„ë¡ì‹œ ì„œë²„ ì—°ê²° ìƒíƒœ í™•ì¸
        async function checkProxyServer() {
            if (window.location.protocol === 'file:') {
                const statusDiv = document.getElementById('proxy-status');
                if (statusDiv) {
                    statusDiv.innerHTML = `
                        <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #dc3545;">
                            <strong>âŒ ì˜ëª»ëœ ì ‘ì† ë°©ë²•</strong><br>
                            í”„ë¡ì‹œ ì„œë²„ë¥¼ ì‹œì‘í•˜ê³  <strong>http://localhost:8000</strong>ìœ¼ë¡œ ì ‘ì†í•˜ì„¸ìš”.
                        </div>
                    `;
                }
                USE_PROXY = false;
                return false;
            }
            
            try {
                const response = await fetch(`${PROXY_URL}/`, { method: 'HEAD', cache: 'no-cache' });
                USE_PROXY = true;
                API_BASE_URL = PROXY_URL;
                return true;
            } catch (error) {
                const statusDiv = document.getElementById('proxy-status');
                if (statusDiv) {
                    statusDiv.innerHTML = `
                        <div style="background: #fff3cd; color: #856404; padding: 15px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                            <strong>âš  í”„ë¡ì‹œ ì„œë²„ ì—°ê²° ì‹¤íŒ¨</strong><br>
                            <code>start_server.bat</code>ì„ ì‹¤í–‰í•˜ê±°ë‚˜ <code>python proxy_server.py</code>ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.
                        </div>
                    `;
                }
                USE_PROXY = false;
                return false;
            }
        }
        
        window.addEventListener('DOMContentLoaded', checkProxyServer);

        // API Key ê´€ë¦¬
        document.addEventListener('DOMContentLoaded', function() {
            const savedApiKey = localStorage.getItem('maplestory_api_key');
            if (savedApiKey) {
                document.getElementById('api-key').value = savedApiKey;
                updateApiKeyStatus(true);
            } else {
                updateApiKeyStatus(false);
            }
        });

        function saveApiKey() {
            const apiKey = document.getElementById('api-key').value.trim();
            if (!apiKey) {
                alert('API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            localStorage.setItem('maplestory_api_key', apiKey);
            updateApiKeyStatus(true);
            
            const saveBtn = document.getElementById('save-key-btn');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'âœ“ ì €ì¥ë¨';
            setTimeout(() => { saveBtn.textContent = originalText; }, 2000);
        }

        function updateApiKeyStatus(isSaved) {
            const statusDiv = document.getElementById('api-key-status');
            if (isSaved) {
                const apiKey = document.getElementById('api-key').value.trim();
                const maskedKey = apiKey ? apiKey.substring(0, 8) + '...' + apiKey.substring(apiKey.length - 4) : '';
                statusDiv.innerHTML = `<span style="color: #28a745;">âœ“ API Keyê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (${maskedKey})</span>`;
            } else {
                statusDiv.innerHTML = '<span style="color: #ffc107;">âš  API Keyë¥¼ ì…ë ¥í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”.</span>';
            }
        }

        function getApiKey() {
            const inputKey = document.getElementById('api-key').value.trim();
            return inputKey || localStorage.getItem('maplestory_api_key') || '';
        }

        // ë‚ ì§œ í¬ë§· í•¨ìˆ˜
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // API í˜¸ì¶œ í•¨ìˆ˜ë“¤
        async function getCharacterOcid(characterName, apiKey) {
            const url = USE_PROXY 
                ? `${API_BASE_URL}/api/maplestory/id?character_name=${encodeURIComponent(characterName)}`
                : `${DIRECT_API_BASE_URL}/maplestory/v1/id?character_name=${encodeURIComponent(characterName)}`;
            
            const response = await fetch(url, {
                headers: { 'x-nxopen-api-key': apiKey }
            });

            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.message || `API ìš”ì²­ ì‹¤íŒ¨ (${response.status})`);
            }

            const data = await response.json();
            if (!data.ocid) throw new Error('ìºë¦­í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return data.ocid;
        }

        async function getCharacterBasicInfo(ocid, apiKey) {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const dateString = formatDate(yesterday);

            const url = USE_PROXY 
                ? `${API_BASE_URL}/api/maplestory/character/basic?ocid=${ocid}&date=${dateString}`
                : `${DIRECT_API_BASE_URL}/maplestory/v1/character/basic?ocid=${ocid}&date=${dateString}`;
            
            const response = await fetch(url, {
                headers: { 'x-nxopen-api-key': apiKey }
            });

            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.message || `API ìš”ì²­ ì‹¤íŒ¨ (${response.status})`);
            }

            return await response.json();
        }

        // ì¥ì°© ì•„ì´í…œ ì •ë³´ ì¡°íšŒ (ìƒˆë¡œ ì¶”ê°€!)
        async function getCharacterEquipment(ocid, apiKey) {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const dateString = formatDate(yesterday);

            const url = USE_PROXY 
                ? `${API_BASE_URL}/api/maplestory/character/item-equipment?ocid=${ocid}&date=${dateString}`
                : `${DIRECT_API_BASE_URL}/maplestory/v1/character/item-equipment?ocid=${ocid}&date=${dateString}`;
            
            const response = await fetch(url, {
                headers: { 'x-nxopen-api-key': apiKey }
            });

            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.message || `ì¥ë¹„ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨ (${response.status})`);
            }

            return await response.json();
        }

        // ì¥ë¹„ ì •ë³´ í‘œì‹œ í•¨ìˆ˜
        function displayEquipment(equipmentData) {
            if (!equipmentData || !equipmentData.item_equipment || equipmentData.item_equipment.length === 0) {
                return '<div class="no-equipment">ì¥ì°©ëœ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            }

            let html = '<div class="equipment-grid">';
            
            equipmentData.item_equipment.forEach(item => {
                html += `
                    <div class="equipment-item">
                        <div class="equipment-item-header">
                            <div class="equipment-name">${item.item_name || 'ì•Œ ìˆ˜ ì—†ìŒ'}</div>
                            <div class="equipment-part">${item.item_equipment_part || 'ë¶€ìœ„'}</div>
                        </div>
                        <div class="equipment-details">
                `;

                // ê¸°ë³¸ ì •ë³´
                if (item.item_total_option) {
                    const opt = item.item_total_option;
                    html += '<div class="equipment-stats">';
                    
                    if (opt.str && opt.str !== '0') html += `<div class="stat-item"><span class="stat-label">STR</span><span class="stat-value">+${opt.str}</span></div>`;
                    if (opt.dex && opt.dex !== '0') html += `<div class="stat-item"><span class="stat-label">DEX</span><span class="stat-value">+${opt.dex}</span></div>`;
                    if (opt.int && opt.int !== '0') html += `<div class="stat-item"><span class="stat-label">INT</span><span class="stat-value">+${opt.int}</span></div>`;
                    if (opt.luk && opt.luk !== '0') html += `<div class="stat-item"><span class="stat-label">LUK</span><span class="stat-value">+${opt.luk}</span></div>`;
                    if (opt.max_hp && opt.max_hp !== '0') html += `<div class="stat-item"><span class="stat-label">HP</span><span class="stat-value">+${opt.max_hp}</span></div>`;
                    if (opt.max_mp && opt.max_mp !== '0') html += `<div class="stat-item"><span class="stat-label">MP</span><span class="stat-value">+${opt.max_mp}</span></div>`;
                    if (opt.attack_power && opt.attack_power !== '0') html += `<div class="stat-item"><span class="stat-label">ê³µê²©ë ¥</span><span class="stat-value">+${opt.attack_power}</span></div>`;
                    if (opt.magic_power && opt.magic_power !== '0') html += `<div class="stat-item"><span class="stat-label">ë§ˆë ¥</span><span class="stat-value">+${opt.magic_power}</span></div>`;
                    if (opt.boss_damage && opt.boss_damage !== '0') html += `<div class="stat-item"><span class="stat-label">ë³´ìŠ¤ ë°ë¯¸ì§€</span><span class="stat-value">+${opt.boss_damage}%</span></div>`;
                    if (opt.ignore_monster_armor && opt.ignore_monster_armor !== '0') html += `<div class="stat-item"><span class="stat-label">ë°©ì–´ìœ¨ ë¬´ì‹œ</span><span class="stat-value">+${opt.ignore_monster_armor}%</span></div>`;
                    
                    html += '</div>';
                }

                // ê°•í™” ì •ë³´
                if (item.scroll_upgrade || item.starforce) {
                    html += '<div class="equipment-detail-row">';
                    if (item.scroll_upgrade) html += `<span class="equipment-detail-label">ì—…ê·¸ë ˆì´ë“œ: ${item.scroll_upgrade}íšŒ</span>`;
                    if (item.starforce) html += `<span class="equipment-detail-value">â­ ${item.starforce}ì„±</span>`;
                    html += '</div>';
                }

                html += `
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            return html;
        }

        // ìºë¦­í„° ì •ë³´ í‘œì‹œ í•¨ìˆ˜
        function displayCharacterInfo(characterInfo, equipmentData) {
            const infoDiv = document.getElementById('character-info');
            
            if (!characterInfo || !characterInfo.character_name) {
                infoDiv.innerHTML = '<div class="error-message">ìºë¦­í„° ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                infoDiv.classList.add('active');
                return;
            }

            let html = `
                <h2>ìºë¦­í„° ì •ë³´</h2>
                <div class="character-layout">
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">ìºë¦­í„°ëª…</div>
                            <div class="info-value">${characterInfo.character_name || 'ì •ë³´ ì—†ìŒ'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ë ˆë²¨</div>
                            <div class="info-value">${characterInfo.character_level || 0}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ì§ì—…</div>
                            <div class="info-value">${characterInfo.character_class || 'ì •ë³´ ì—†ìŒ'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ê¸¸ë“œëª…</div>
                            <div class="info-value">${characterInfo.character_guild_name || 'ê¸¸ë“œ ì—†ìŒ'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ì›”ë“œ</div>
                            <div class="info-value">${characterInfo.world_name || 'ì •ë³´ ì—†ìŒ'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ê²½í—˜ì¹˜</div>
                            <div class="info-value">${characterInfo.character_exp ? characterInfo.character_exp.toLocaleString() : 0}</div>
                        </div>
                    </div>
                    <div class="equipment-section">
                        <h3>ğŸ’ ì¥ì°© ì•„ì´í…œ</h3>
                        ${displayEquipment(equipmentData)}
                    </div>
                </div>
            `;
            
            infoDiv.innerHTML = html;
            infoDiv.classList.add('active');
        }

        // ìºë¦­í„° ê²€ìƒ‰ ë©”ì¸ í•¨ìˆ˜
        async function searchCharacter() {
            const apiKey = getApiKey();
            const characterName = document.getElementById('character-name').value.trim();
            const searchBtn = document.getElementById('search-btn');
            const infoDiv = document.getElementById('character-info');

            if (!apiKey) {
                alert('API Keyë¥¼ ì…ë ¥í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”.');
                document.getElementById('api-key').focus();
                return;
            }

            if (!characterName) {
                alert('ìºë¦­í„° ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            searchBtn.disabled = true;
            searchBtn.textContent = 'ê²€ìƒ‰ ì¤‘...';
            infoDiv.innerHTML = '<div class="loading">ìºë¦­í„° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘</div>';
            infoDiv.classList.add('active');

            try {
                // 1. OCID ì¡°íšŒ
                const ocid = await getCharacterOcid(characterName, apiKey);
                
                // 2. ìºë¦­í„° ê¸°ë³¸ ì •ë³´ ì¡°íšŒ
                const characterInfo = await getCharacterBasicInfo(ocid, apiKey);
                
                // 3. ì¥ì°© ì•„ì´í…œ ì •ë³´ ì¡°íšŒ
                const equipmentData = await getCharacterEquipment(ocid, apiKey);
                
                // 4. ì •ë³´ í‘œì‹œ
                displayCharacterInfo(characterInfo, equipmentData);
            } catch (error) {
                console.error('ìºë¦­í„° ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                infoDiv.innerHTML = `
                    <div class="error-message">
                        <strong>ì˜¤ë¥˜ ë°œìƒ</strong><br>
                        ${error.message}<br>
                        <small style="margin-top: 10px; display: block; color: #666;">
                            ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬(F12)ì˜ ì½˜ì†” íƒ­ì—ì„œ ìì„¸í•œ ì˜¤ë¥˜ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </small>
                    </div>
                `;
                infoDiv.classList.add('active');
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = 'ê²€ìƒ‰';
            }
        }
    </script>
</body>
</html>
