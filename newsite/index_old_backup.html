<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë©”ì´í”ŒìŠ¤í† ë¦¬ ìºë¦­í„° ê²€ìƒ‰ & ë­í‚¹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .api-key-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .api-key-section input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .search-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-box input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .search-box button {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s;
        }

        .search-box button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .search-box button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .character-info {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
        }

        .character-info.active {
            display: block;
        }

        .character-info h2 {
            color: #667eea;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
        }

        .info-label {
            font-weight: bold;
            color: #666;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 18px;
            color: #333;
        }

        .ranking-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .ranking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .ranking-header h2 {
            color: #667eea;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
            flex: 1;
        }

        .ranking-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .ranking-controls select,
        .ranking-controls button {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .ranking-controls button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            padding: 10px 20px;
        }

        .ranking-controls button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .ranking-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .ranking-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }

        .ranking-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #ddd;
        }

        .ranking-table tr:hover {
            background: #f5f5f5;
        }

        .ranking-table tr:nth-child(even) {
            background: #fafafa;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            border-left: 4px solid #c33;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ ë©”ì´í”ŒìŠ¤í† ë¦¬ ìºë¦­í„° ê²€ìƒ‰ & ë­í‚¹</h1>
            <p>ë„¥ìŠ¨ Open APIë¥¼ í™œìš©í•œ ìºë¦­í„° ì •ë³´ ì¡°íšŒ</p>
        </div>

        <!-- í”„ë¡ì‹œ ì„œë²„ ìƒíƒœ í‘œì‹œ -->
        <div id="proxy-status"></div>
        
        <!-- API Key ì…ë ¥ ì˜ì—­ -->
        <div class="api-key-section">
            <label for="api-key" style="display: block; margin-bottom: 10px; font-weight: bold; color: #333;">
                ğŸ”‘ API Key ì…ë ¥
            </label>
            <div style="display: flex; gap: 10px;">
                <input type="password" id="api-key" placeholder="ë„¥ìŠ¨ Open API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”" 
                       onkeypress="if(event.key === 'Enter') saveApiKey()"
                       style="flex: 1;">
                <button onclick="saveApiKey()" id="save-key-btn" style="padding: 12px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">ì €ì¥</button>
            </div>
            <div id="api-key-status" style="margin-top: 10px; font-size: 14px;"></div>
        </div>

        <!-- ìºë¦­í„° ê²€ìƒ‰ ì˜ì—­ -->
        <div class="search-section">
            <h2 style="color: #667eea; margin-bottom: 20px;">ìºë¦­í„° ê²€ìƒ‰</h2>
            <div class="search-box">
                <input type="text" id="character-name" placeholder="ìºë¦­í„° ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" 
                       onkeypress="if(event.key === 'Enter') searchCharacter()">
                <button onclick="searchCharacter()" id="search-btn">ê²€ìƒ‰</button>
            </div>
            <div id="character-info" class="character-info"></div>
        </div>

        <!-- ì›”ë“œ ë­í‚¹ ì˜ì—­ -->
        <div class="ranking-section">
            <div class="ranking-header">
                <h2>ì›”ë“œ ë­í‚¹</h2>
                <div class="ranking-controls">
                    <select id="world-select">
                        <option value="ìŠ¤ì¹´ë‹ˆì•„">ìŠ¤ì¹´ë‹ˆì•„</option>
                        <option value="ë² ë¼">ë² ë¼</option>
                        <option value="ë£¨ë‚˜">ë£¨ë‚˜</option>
                        <option value="ì œë‹ˆìŠ¤">ì œë‹ˆìŠ¤</option>
                        <option value="í¬ë¡œì•„">í¬ë¡œì•„</option>
                        <option value="ìœ ë‹ˆì˜¨">ìœ ë‹ˆì˜¨</option>
                        <option value="ì—˜ë¦¬ì‹œì›€">ì—˜ë¦¬ì‹œì›€</option>
                        <option value="ì´ë…¸ì‹œìŠ¤">ì´ë…¸ì‹œìŠ¤</option>
                        <option value="ë ˆë“œ">ë ˆë“œ</option>
                        <option value="ì˜¤ë¡œë¼">ì˜¤ë¡œë¼</option>
                        <option value="ì•„ì¼€ì¸">ì•„ì¼€ì¸</option>
                        <option value="ë…¸ë°”">ë…¸ë°”</option>
                        <option value="ë¦¬ë¶€íŠ¸">ë¦¬ë¶€íŠ¸</option>
                        <option value="ë¦¬ë¶€íŠ¸2">ë¦¬ë¶€íŠ¸2</option>
                        <option value="ë²„ë‹">ë²„ë‹</option>
                        <option value="ë²„ë‹2">ë²„ë‹2</option>
                        <option value="ë²„ë‹3">ë²„ë‹3</option>
                    </select>
                    <button onclick="loadRanking()" id="ranking-btn">ë­í‚¹ ì¡°íšŒ</button>
                </div>
            </div>
            <div id="ranking-container">
                <p style="text-align: center; color: #666; padding: 40px;">
                    ìœ„ì˜ "ë­í‚¹ ì¡°íšŒ" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì›”ë“œ ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.
                </p>
            </div>
        </div>
    </div>

    <script>
        // API ê¸°ë³¸ URL ì„¤ì •
        // í”„ë¡ì‹œ ì„œë²„ í¬íŠ¸ ì„¤ì • (Python ì„œë²„ëŠ” 8000, Node.js ì„œë²„ëŠ” 3000)
        const PROXY_PORT = 8000;  // Python ì„œë²„ í¬íŠ¸
        const PROXY_URL = `http://localhost:${PROXY_PORT}`;
        const DIRECT_API_BASE_URL = 'https://open.api.nexon.com';
        
        // í”„ë¡ì‹œ ì„œë²„ ì‚¬ìš© ì—¬ë¶€ (ìë™ ê°ì§€)
        let USE_PROXY = true;
        let API_BASE_URL = PROXY_URL;
        
        // í˜„ì¬ í˜ì´ì§€ê°€ file:// í”„ë¡œí† ì½œë¡œ ì—´ë ¸ëŠ”ì§€ í™•ì¸
        function checkProtocol() {
            if (window.location.protocol === 'file:') {
                const statusDiv = document.getElementById('proxy-status');
                if (statusDiv) {
                    statusDiv.innerHTML = `
                        <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #dc3545;">
                            <strong>âŒ ì˜ëª»ëœ ì ‘ì† ë°©ë²•</strong><br>
                            íŒŒì¼ì„ ì§ì ‘ ì—´ì–´ì„œëŠ” ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!<br>
                            <br>
                            <strong>ì˜¬ë°”ë¥¸ ë°©ë²•:</strong><br>
                            1. í”„ë¡ì‹œ ì„œë²„ ì‹œì‘: <code>start_server.bat</code> íŒŒì¼ ë”ë¸”í´ë¦­<br>
                            2. ë¸Œë¼ìš°ì €ì—ì„œ <strong>http://localhost:8000</strong> ì£¼ì†Œë¡œ ì ‘ì†<br>
                            <br>
                            í˜„ì¬ ì£¼ì†Œ: <code>${window.location.href}</code>
                        </div>
                    `;
                }
                return false;
            }
            return true;
        }
        
        // í”„ë¡ì‹œ ì„œë²„ ì—°ê²° ìƒíƒœ í™•ì¸
        async function checkProxyServer() {
            if (!checkProtocol()) {
                USE_PROXY = false;
                return false;
            }
            
            try {
                // ê°„ë‹¨í•œ í—¤ë“œ ìš”ì²­ìœ¼ë¡œ ì„œë²„ í™•ì¸
                const response = await fetch(`${PROXY_URL}/`, {
                    method: 'HEAD',
                    cache: 'no-cache'
                });
                console.log('í”„ë¡ì‹œ ì„œë²„ ì—°ê²° ì„±ê³µ:', response.status);
                USE_PROXY = true;
                API_BASE_URL = PROXY_URL;
                return true;
            } catch (error) {
                console.error('í”„ë¡ì‹œ ì„œë²„ ì—°ê²° ì‹¤íŒ¨:', error);
                const statusDiv = document.getElementById('proxy-status');
                if (statusDiv) {
                    statusDiv.innerHTML = `
                        <div style="background: #fff3cd; color: #856404; padding: 15px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                            <strong>âš  í”„ë¡ì‹œ ì„œë²„ ì—°ê²° ì‹¤íŒ¨</strong><br>
                            ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.<br>
                            <br>
                            <strong>í•´ê²° ë°©ë²•:</strong><br>
                            1. <code>start_server.bat</code> íŒŒì¼ì„ ë”ë¸”í´ë¦­í•˜ê±°ë‚˜<br>
                            2. í„°ë¯¸ë„ì—ì„œ <code>python proxy_server.py</code> ì‹¤í–‰<br>
                            <br>
                            ì„œë²„ ì£¼ì†Œ: <code>${PROXY_URL}</code><br>
                            í˜„ì¬ ì ‘ì† ì£¼ì†Œ: <code>${window.location.origin}</code>
                        </div>
                    `;
                }
                USE_PROXY = false;
                return false;
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ í”„ë¡ì‹œ ì„œë²„ í™•ì¸
        window.addEventListener('DOMContentLoaded', function() {
            checkProxyServer();
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ API Key ë¶ˆëŸ¬ì˜¤ê¸°
        document.addEventListener('DOMContentLoaded', function() {
            const savedApiKey = localStorage.getItem('maplestory_api_key');
            if (savedApiKey) {
                document.getElementById('api-key').value = savedApiKey;
                updateApiKeyStatus(true);
            } else {
                updateApiKeyStatus(false);
            }
            
            // API Key ì…ë ¥ í•„ë“œ ë³€ê²½ ê°ì§€
            const apiKeyInput = document.getElementById('api-key');
            apiKeyInput.addEventListener('input', function() {
                const currentValue = this.value.trim();
                const savedValue = localStorage.getItem('maplestory_api_key');
                if (currentValue !== savedValue && currentValue.length > 0) {
                    updateApiKeyStatus(false);
                } else if (currentValue === savedValue && savedValue) {
                    updateApiKeyStatus(true);
                }
            });
        });

        // API Key ì €ì¥ í•¨ìˆ˜
        function saveApiKey() {
            const apiKey = document.getElementById('api-key').value.trim();
            if (!apiKey) {
                alert('API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            localStorage.setItem('maplestory_api_key', apiKey);
            updateApiKeyStatus(true);
            
            // ì €ì¥ ë²„íŠ¼ í”¼ë“œë°±
            const saveBtn = document.getElementById('save-key-btn');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'âœ“ ì €ì¥ë¨';
            saveBtn.style.background = '#28a745';
            
            setTimeout(() => {
                saveBtn.textContent = originalText;
            }, 2000);
        }

        // API Key ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateApiKeyStatus(isSaved) {
            const statusDiv = document.getElementById('api-key-status');
            if (isSaved) {
                const apiKey = document.getElementById('api-key').value.trim();
                const maskedKey = apiKey ? apiKey.substring(0, 8) + '...' + apiKey.substring(apiKey.length - 4) : '';
                statusDiv.innerHTML = `<span style="color: #28a745;">âœ“ API Keyê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (${maskedKey})</span>`;
            } else {
                statusDiv.innerHTML = '<span style="color: #ffc107;">âš  API Keyë¥¼ ì…ë ¥í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”.</span>';
            }
        }


        /**
         * 1ë‹¨ê³„: ìºë¦­í„° ì´ë¦„ìœ¼ë¡œ OCID ì¡°íšŒ
         * @param {string} characterName - ìºë¦­í„° ì´ë¦„
         * @param {string} apiKey - API Key
         * @returns {Promise<string>} - OCID ë˜ëŠ” ì—ëŸ¬ ë©”ì‹œì§€
         */
        async function getCharacterOcid(characterName, apiKey) {
            if (!characterName || !apiKey) {
                throw new Error('ìºë¦­í„° ì´ë¦„ê³¼ API Keyë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }

            try {
                console.log('OCID ì¡°íšŒ ì‹œì‘:', characterName);
                console.log('API Key ê¸¸ì´:', apiKey ? apiKey.length : 0);
                console.log('API Key ì• 4ìë¦¬:', apiKey ? apiKey.substring(0, 4) : 'ì—†ìŒ');
                
                let url, headers;
                
                if (USE_PROXY) {
                    // í”„ë¡ì‹œ ì„œë²„ë¥¼ í†µí•œ ìš”ì²­
                    url = `${API_BASE_URL}/api/maplestory/id?character_name=${encodeURIComponent(characterName)}`;
                    headers = {
                        'x-nxopen-api-key': apiKey,
                        'Content-Type': 'application/json'
                    };
                } else {
                    // ì§ì ‘ API í˜¸ì¶œ (CORS ë¬¸ì œ ê°€ëŠ¥)
                    url = `${DIRECT_API_BASE_URL}/maplestory/v1/id?character_name=${encodeURIComponent(characterName)}`;
                    headers = {
                        'x-nxopen-api-key': apiKey
                    };
                }
                
                console.log('ìš”ì²­ URL:', url);
                console.log('ìš”ì²­ í—¤ë”:', headers);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: headers
                });

                console.log('ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);

                if (!response.ok) {
                    let errorMessage = `API ìš”ì²­ ì‹¤íŒ¨ (${response.status})`;
                    let errorDetails = {};
                    
                    try {
                        const errorData = await response.json();
                        console.log('ì—ëŸ¬ ì‘ë‹µ ë°ì´í„°:', errorData);
                        errorMessage = errorData.message || errorData.error || errorMessage;
                        errorDetails = errorData;
                    } catch (e) {
                        const errorText = await response.text();
                        console.log('ì—ëŸ¬ ì‘ë‹µ í…ìŠ¤íŠ¸:', errorText);
                        errorMessage = errorText || errorMessage;
                    }
                    
                    // 400 ì˜¤ë¥˜ì— ëŒ€í•œ ìƒì„¸ ì•ˆë‚´
                    if (response.status === 400) {
                        let detailedMessage = 'API ìš”ì²­ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤ (400 ì˜¤ë¥˜).\n\n';
                        
                        if (!apiKey || apiKey.trim() === '') {
                            detailedMessage += 'âŒ API Keyê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n';
                            detailedMessage += 'í•´ê²°: API Keyë¥¼ ì…ë ¥í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”.\n\n';
                        } else if (!characterName || characterName.trim() === '') {
                            detailedMessage += 'âŒ ìºë¦­í„° ì´ë¦„ì´ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n';
                            detailedMessage += 'í•´ê²°: ìºë¦­í„° ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n\n';
                        } else {
                            detailedMessage += 'ê°€ëŠ¥í•œ ì›ì¸:\n';
                            detailedMessage += '1. API Keyê°€ ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤\n';
                            detailedMessage += '2. API Key í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤\n';
                            detailedMessage += '3. ìºë¦­í„° ì´ë¦„ì— íŠ¹ìˆ˜ë¬¸ìê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤\n';
                            detailedMessage += '4. ë„¥ìŠ¨ API ì„œë¹„ìŠ¤ì— ì¼ì‹œì ì¸ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤\n\n';
                        }
                        
                        detailedMessage += `ìƒì„¸ ì˜¤ë¥˜: ${errorMessage}\n\n`;
                        detailedMessage += 'ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬(F12) â†’ Console íƒ­ì—ì„œ ë” ìì„¸í•œ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.';
                        
                        throw new Error(detailedMessage);
                    }
                    
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                console.log('ì‘ë‹µ ë°ì´í„°:', data);
                
                if (!data.ocid) {
                    throw new Error('ìºë¦­í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìºë¦­í„° ì´ë¦„ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }

                return data.ocid;
            } catch (error) {
                console.error('OCID ì¡°íšŒ ì˜¤ë¥˜:', error);
                console.error('í”„ë¡ì‹œ ì‚¬ìš© ì—¬ë¶€:', USE_PROXY);
                console.error('API_BASE_URL:', API_BASE_URL);
                console.error('ìš”ì²­ URL:', url);
                console.error('í˜„ì¬ í˜ì´ì§€ URL:', window.location.href);
                
                // CORS ì—ëŸ¬ ê°ì§€
                if (error.name === 'TypeError' && (error.message.includes('Failed to fetch') || error.message.includes('NetworkError'))) {
                    let errorMsg = 'CORS ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n';
                    errorMsg += `í˜„ì¬ í˜ì´ì§€: ${window.location.href}\n`;
                    errorMsg += `í”„ë¡ì‹œ ì‚¬ìš©: ${USE_PROXY ? 'ì˜ˆ' : 'ì•„ë‹ˆì˜¤'}\n`;
                    errorMsg += `API URL: ${url}\n\n`;
                    
                    if (window.location.protocol === 'file:') {
                        errorMsg += 'âŒ íŒŒì¼ì„ ì§ì ‘ ì—´ì—ˆìŠµë‹ˆë‹¤!\n';
                        errorMsg += 'í•´ê²°: í”„ë¡ì‹œ ì„œë²„ë¥¼ ì‹œì‘í•˜ê³  http://localhost:8000ìœ¼ë¡œ ì ‘ì†í•˜ì„¸ìš”.';
                    } else if (!USE_PROXY) {
                        errorMsg += 'âŒ í”„ë¡ì‹œ ì„œë²„ê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!\n';
                        errorMsg += 'í•´ê²°: start_server.batì„ ì‹¤í–‰í•˜ê±°ë‚˜ python proxy_server.pyë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.';
                    } else {
                        errorMsg += 'âŒ í”„ë¡ì‹œ ì„œë²„ê°€ ì‘ë‹µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!\n';
                        errorMsg += 'í•´ê²°: í”„ë¡ì‹œ ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.';
                    }
                    
                    throw new Error(errorMsg);
                }
                
                throw error;
            }
        }

        /**
         * 2ë‹¨ê³„: ìºë¦­í„° ê¸°ë³¸ ì •ë³´ ì¡°íšŒ
         * @param {string} ocid - ìºë¦­í„° OCID
         * @param {string} apiKey - API Key
         * @returns {Promise<Object>} - ìºë¦­í„° ê¸°ë³¸ ì •ë³´
         */
        async function getCharacterBasicInfo(ocid, apiKey) {
            if (!ocid || !apiKey) {
                throw new Error('OCIDì™€ API Keyê°€ í•„ìš”í•©ë‹ˆë‹¤.');
            }

            // ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ìƒì„±
            // ë„¥ìŠ¨ APIëŠ” í•œêµ­ ì‹œê°„(UTC+9) ê¸°ì¤€ì´ë©°, ì˜¤ëŠ˜ ë‚ ì§œ ë°ì´í„°ê°€ ì•„ì§ ì—…ë°ì´íŠ¸ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŒ
            // ë”°ë¼ì„œ ê¸°ë³¸ì ìœ¼ë¡œ ì–´ì œ ë‚ ì§œë¥¼ ì‚¬ìš©í•˜ê³ , ì‹¤íŒ¨ ì‹œ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì¬ì‹œë„
            
            // ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
            function formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            // í˜„ì¬ ë‚ ì§œ (ë¡œì»¬ ì‹œê°„ ê¸°ì¤€, ë” ì•ˆì •ì )
            const today = new Date();
            const todayString = formatDate(today);
            
            // ì–´ì œ ë‚ ì§œ ê³„ì‚° (ê¸°ë³¸ê°’ìœ¼ë¡œ ì‚¬ìš©, ë” ì•ˆì •ì )
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const dateString = formatDate(yesterday);

            console.log('ìºë¦­í„° ê¸°ë³¸ ì •ë³´ ì¡°íšŒ ì‹œì‘:', { ocid, date: dateString, todayDate: todayString });

            try {
                let url, headers;
                
                if (USE_PROXY) {
                    url = `${API_BASE_URL}/api/maplestory/character/basic?ocid=${ocid}&date=${dateString}`;
                    headers = {
                        'x-nxopen-api-key': apiKey,
                        'Content-Type': 'application/json'
                    };
                } else {
                    url = `${DIRECT_API_BASE_URL}/maplestory/v1/character/basic?ocid=${ocid}&date=${dateString}`;
                    headers = {
                        'x-nxopen-api-key': apiKey
                    };
                }
                
                console.log('ìš”ì²­ URL:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: headers
                });

                console.log('ì‘ë‹µ ìƒíƒœ:', response.status, response.statusText);

                if (!response.ok) {
                    let errorMessage = `API ìš”ì²­ ì‹¤íŒ¨ (${response.status})`;
                    let errorDetails = {};
                    
                    try {
                        const errorData = await response.json();
                        console.log('ì—ëŸ¬ ì‘ë‹µ ë°ì´í„°:', errorData);
                        // ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜
                        if (typeof errorData === 'object') {
                            errorMessage = errorData.message || errorData.error || JSON.stringify(errorData);
                        } else {
                            errorMessage = errorData || errorMessage;
                        }
                        errorDetails = errorData;
                    } catch (e) {
                        const errorText = await response.text();
                        console.log('ì—ëŸ¬ ì‘ë‹µ í…ìŠ¤íŠ¸:', errorText);
                        errorMessage = errorText || errorMessage;
                    }
                    
                    // 400 ì˜¤ë¥˜ì¸ ê²½ìš° ìƒì„¸ ì •ë³´ ì œê³µ
                    if (response.status === 400) {
                        let detailedError = `ìºë¦­í„° ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨ (400 ì˜¤ë¥˜)\n\n`;
                        detailedError += `ìš”ì²­í•œ OCID: ${ocid}\n`;
                        detailedError += `ìš”ì²­í•œ ë‚ ì§œ: ${dateString}\n\n`;
                        
                        // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì¬ì‹œë„
                        console.log('ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì¬ì‹œë„ ì‹œë„...');
                        try {
                            const retryUrl = USE_PROXY 
                                ? `${API_BASE_URL}/api/maplestory/character/basic?ocid=${ocid}&date=${todayString}`
                                : `${DIRECT_API_BASE_URL}/maplestory/v1/character/basic?ocid=${ocid}&date=${todayString}`;
                            
                            console.log('ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì¬ì‹œë„:', retryUrl);
                            const retryResponse = await fetch(retryUrl, {
                                method: 'GET',
                                headers: headers
                            });
                            
                            if (retryResponse.ok) {
                                const retryData = await retryResponse.json();
                                console.log('ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì¬ì‹œë„ ì„±ê³µ');
                                return retryData;
                            } else {
                                const retryErrorText = await retryResponse.text();
                                console.log('ì˜¤ëŠ˜ ë‚ ì§œë¡œë„ ì‹¤íŒ¨:', retryResponse.status, retryErrorText);
                            }
                        } catch (retryError) {
                            console.error('ì¬ì‹œë„ ì‹¤íŒ¨:', retryError);
                        }
                        
                        // ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ì˜¬ë°”ë¥´ê²Œ í‘œì‹œ
                        let errorMsgText = errorMessage;
                        if (typeof errorMessage === 'object') {
                            errorMsgText = JSON.stringify(errorMessage, null, 2);
                        }
                        
                        detailedError += `ìƒì„¸ ì˜¤ë¥˜: ${errorMsgText}`;
                        throw new Error(detailedError);
                    }
                    
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                console.log('ì‘ë‹µ ë°ì´í„°:', data);
                return data;
            } catch (error) {
                console.error('ìºë¦­í„° ê¸°ë³¸ ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error);
                console.error('OCID:', ocid);
                console.error('ë‚ ì§œ:', dateString);
                throw error;
            }
        }

        /**
         * ìºë¦­í„° ì •ë³´ë¥¼ HTMLì— í‘œì‹œ
         * @param {Object} characterInfo - ìºë¦­í„° ê¸°ë³¸ ì •ë³´
         */
        function displayCharacterInfo(characterInfo) {
            const infoDiv = document.getElementById('character-info');
            
            if (!characterInfo || !characterInfo.character_name) {
                infoDiv.innerHTML = '<div class="error-message">ìºë¦­í„° ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                infoDiv.classList.add('active');
                return;
            }

            const html = `
                <h2>ìºë¦­í„° ì •ë³´</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">ìºë¦­í„°ëª…</div>
                        <div class="info-value">${characterInfo.character_name || 'ì •ë³´ ì—†ìŒ'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ë ˆë²¨</div>
                        <div class="info-value">${characterInfo.character_level || 0}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ì§ì—…</div>
                        <div class="info-value">${characterInfo.character_class || 'ì •ë³´ ì—†ìŒ'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ê¸¸ë“œëª…</div>
                        <div class="info-value">${characterInfo.character_guild_name || 'ê¸¸ë“œ ì—†ìŒ'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ì›”ë“œ</div>
                        <div class="info-value">${characterInfo.world_name || 'ì •ë³´ ì—†ìŒ'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ê²½í—˜ì¹˜</div>
                        <div class="info-value">${characterInfo.character_exp || 0}</div>
                    </div>
                </div>
            `;
            
            infoDiv.innerHTML = html;
            infoDiv.classList.add('active');
        }

        /**
         * API Key ê°€ì ¸ì˜¤ê¸° (ì…ë ¥ í•„ë“œ ë˜ëŠ” localStorageì—ì„œ)
         */
        function getApiKey() {
            const inputKey = document.getElementById('api-key').value.trim();
            if (inputKey) {
                return inputKey;
            }
            return localStorage.getItem('maplestory_api_key') || '';
        }

        /**
         * ìºë¦­í„° ê²€ìƒ‰ ë©”ì¸ í•¨ìˆ˜
         */
        async function searchCharacter() {
            const apiKey = getApiKey();
            const characterName = document.getElementById('character-name').value.trim();
            const searchBtn = document.getElementById('search-btn');
            const infoDiv = document.getElementById('character-info');

            // ì…ë ¥ ê²€ì¦
            if (!apiKey) {
                alert('API Keyë¥¼ ì…ë ¥í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”.');
                document.getElementById('api-key').focus();
                return;
            }

            if (!characterName) {
                alert('ìºë¦­í„° ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            searchBtn.disabled = true;
            searchBtn.textContent = 'ê²€ìƒ‰ ì¤‘...';
            infoDiv.innerHTML = '<div class="loading">ìºë¦­í„° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘</div>';
            infoDiv.classList.add('active');

            try {
                // 1ë‹¨ê³„: OCID ì¡°íšŒ
                const ocid = await getCharacterOcid(characterName, apiKey);
                
                // 2ë‹¨ê³„: ìºë¦­í„° ê¸°ë³¸ ì •ë³´ ì¡°íšŒ
                const characterInfo = await getCharacterBasicInfo(ocid, apiKey);
                
                // 3ë‹¨ê³„: ì •ë³´ í‘œì‹œ
                displayCharacterInfo(characterInfo);
            } catch (error) {
                console.error('ìºë¦­í„° ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                let errorMessage = error.message;
                
                // 400 ì˜¤ë¥˜ì¸ ê²½ìš°
                if (errorMessage.includes('400') || errorMessage.includes('ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤')) {
                    infoDiv.innerHTML = `
                        <div class="error-message">
                            <strong>âŒ API ìš”ì²­ ì˜¤ë¥˜ (400)</strong><br><br>
                            ${errorMessage.split('\n').join('<br>')}
                            <br><br>
                            <strong>âœ… í•´ê²° ë°©ë²•:</strong><br>
                            1. API Keyê°€ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥ë˜ê³  ì €ì¥ë˜ì—ˆëŠ”ì§€ í™•ì¸<br>
                            2. ë„¥ìŠ¨ ê°œë°œì ì„¼í„°ì—ì„œ API Keyê°€ ìœ íš¨í•œì§€ í™•ì¸<br>
                            3. ìºë¦­í„° ì´ë¦„ì„ ì •í™•íˆ ì…ë ¥í–ˆëŠ”ì§€ í™•ì¸<br>
                            4. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„
                        </div>
                    `;
                    infoDiv.classList.add('active');
                    return;
                }
                
                // CORS ì—ëŸ¬ì¸ ê²½ìš° ë” ìì„¸í•œ ì•ˆë‚´
                if (errorMessage.includes('CORS') || error.message.includes('Failed to fetch')) {
                    const currentUrl = window.location.href;
                    const isFileProtocol = window.location.protocol === 'file:';
                    
                    let solutionSteps = '';
                    if (isFileProtocol) {
                        solutionSteps = `
                            <strong>âŒ ì˜ëª»ëœ ì ‘ì† ë°©ë²•ì…ë‹ˆë‹¤!</strong><br>
                            íŒŒì¼ì„ ì§ì ‘ ì—´ì–´ì„œëŠ” ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br>
                            <br>
                            <strong>âœ… ì˜¬ë°”ë¥¸ ì ‘ì† ë°©ë²•:</strong><br>
                            1. í”„ë¡ì‹œ ì„œë²„ ì‹œì‘: <code>start_server.bat</code> íŒŒì¼ ë”ë¸”í´ë¦­<br>
                            2. ë¸Œë¼ìš°ì €ì—ì„œ <strong style="color: #007bff;">http://localhost:8000</strong> ì£¼ì†Œ ì…ë ¥<br>
                            3. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„<br>
                        `;
                    } else {
                        solutionSteps = `
                            <strong>âŒ í”„ë¡ì‹œ ì„œë²„ê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!</strong><br>
                            <br>
                            <strong>âœ… í•´ê²° ë°©ë²•:</strong><br>
                            1. <code>start_server.bat</code> íŒŒì¼ì„ ë”ë¸”í´ë¦­í•˜ì„¸ìš”<br>
                            2. ë˜ëŠ” í„°ë¯¸ë„ì—ì„œ <code>python proxy_server.py</code> ì‹¤í–‰<br>
                            3. ì„œë²„ê°€ ì‹œì‘ë˜ë©´ ì´ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨(F5)í•˜ì„¸ìš”<br>
                            <br>
                            <small>í˜„ì¬ ì ‘ì† ì£¼ì†Œ: <code>${currentUrl}</code></small><br>
                            <small>í•„ìš”í•œ ì£¼ì†Œ: <code>http://localhost:8000</code></small>
                        `;
                    }
                    
                    errorMessage = solutionSteps;
                }
                
                infoDiv.innerHTML = `
                    <div class="error-message">
                        <strong>ì˜¤ë¥˜ ë°œìƒ</strong><br>
                        ${errorMessage}<br>
                        <small style="margin-top: 10px; display: block; color: #666;">
                            ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬(F12)ì˜ ì½˜ì†” íƒ­ì—ì„œ ìì„¸í•œ ì˜¤ë¥˜ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </small>
                    </div>
                `;
                infoDiv.classList.add('active');
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = 'ê²€ìƒ‰';
            }
        }

        /**
         * 3ë‹¨ê³„: ì›”ë“œ ë­í‚¹ ì¡°íšŒ
         * @param {string} apiKey - API Key
         * @param {string} worldName - ì›”ë“œ ì´ë¦„
         * @param {number} page - í˜ì´ì§€ ë²ˆí˜¸ (1ë¶€í„° ì‹œì‘)
         * @returns {Promise<Object>} - ë­í‚¹ ì •ë³´
         */
        async function getWorldRanking(apiKey, worldName, page = 1) {
            if (!apiKey) {
                throw new Error('API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }

            // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ìƒì„±
            const today = new Date();
            const dateString = today.toISOString().split('T')[0];

            try {
                let url, headers;
                
                if (USE_PROXY) {
                    url = `${API_BASE_URL}/api/maplestory/ranking/overall?date=${dateString}&world_name=${encodeURIComponent(worldName)}&page=${page}`;
                    headers = {
                        'x-nxopen-api-key': apiKey,
                        'Content-Type': 'application/json'
                    };
                } else {
                    url = `${DIRECT_API_BASE_URL}/maplestory/v1/ranking/overall?date=${dateString}&world_name=${encodeURIComponent(worldName)}&page=${page}`;
                    headers = {
                        'x-nxopen-api-key': apiKey
                    };
                }
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: headers
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `API ìš”ì²­ ì‹¤íŒ¨: ${response.status}`);
                }

                const data = await response.json();
                return data;
            } catch (error) {
                throw error;
            }
        }

        /**
         * ë­í‚¹ ì •ë³´ë¥¼ HTML í…Œì´ë¸”ì— í‘œì‹œ
         * @param {Array} rankingList - ë­í‚¹ ë°°ì—´
         */
        function displayRanking(rankingList) {
            const container = document.getElementById('ranking-container');

            if (!rankingList || rankingList.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">ë­í‚¹ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            let html = `
                <table class="ranking-table">
                    <thead>
                        <tr>
                            <th>ìˆœìœ„</th>
                            <th>ìºë¦­í„°ëª…</th>
                            <th>ë ˆë²¨</th>
                            <th>ì§ì—…</th>
                            <th>ì›”ë“œ</th>
                            <th>ê²½í—˜ì¹˜</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            rankingList.forEach((character, index) => {
                const rank = character.ranking || (index + 1);
                html += `
                    <tr>
                        <td>${rank}</td>
                        <td>${character.character_name || 'ì •ë³´ ì—†ìŒ'}</td>
                        <td>${character.character_level || 0}</td>
                        <td>${character.character_class || 'ì •ë³´ ì—†ìŒ'}</td>
                        <td>${character.world_name || 'ì •ë³´ ì—†ìŒ'}</td>
                        <td>${character.character_exp ? character.character_exp.toLocaleString() : 0}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        /**
         * ì›”ë“œ ë­í‚¹ ì¡°íšŒ ë©”ì¸ í•¨ìˆ˜
         */
        async function loadRanking() {
            const apiKey = getApiKey();
            const worldName = document.getElementById('world-select').value;
            const rankingBtn = document.getElementById('ranking-btn');
            const container = document.getElementById('ranking-container');

            // API Key ê²€ì¦
            if (!apiKey) {
                alert('API Keyë¥¼ ì…ë ¥í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”.');
                document.getElementById('api-key').focus();
                return;
            }

            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            rankingBtn.disabled = true;
            rankingBtn.textContent = 'ì¡°íšŒ ì¤‘...';
            container.innerHTML = '<div class="loading">ë­í‚¹ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘</div>';

            try {
                // ì—¬ëŸ¬ í˜ì´ì§€ë¥¼ ì¡°íšŒí•˜ì—¬ ìƒìœ„ 100ìœ„ ê°€ì ¸ì˜¤ê¸°
                // APIëŠ” í˜ì´ì§€ë‹¹ 200ê°œì˜ ë°ì´í„°ë¥¼ ë°˜í™˜í•˜ì§€ë§Œ, ì•ˆì •ì„±ì„ ìœ„í•´ ì—¬ëŸ¬ í˜ì´ì§€ ì¡°íšŒ
                const allRankings = [];
                let page = 1;
                let hasMore = true;
                const maxResults = 100;

                while (hasMore && allRankings.length < maxResults) {
                    const rankingData = await getWorldRanking(apiKey, worldName, page);
                    
                    if (rankingData.ranking && rankingData.ranking.length > 0) {
                        allRankings.push(...rankingData.ranking);
                        page++;
                        
                        // ë” ì´ìƒ ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ì›í•˜ëŠ” ê°œìˆ˜ì— ë„ë‹¬í•˜ë©´ ì¤‘ë‹¨
                        if (rankingData.ranking.length < 200 || allRankings.length >= maxResults) {
                            hasMore = false;
                        }
                    } else {
                        hasMore = false;
                    }
                }

                // ìƒìœ„ 100ìœ„ë§Œ í‘œì‹œ
                const top100 = allRankings.slice(0, maxResults);
                displayRanking(top100);

            } catch (error) {
                container.innerHTML = `<div class="error-message">ì˜¤ë¥˜: ${error.message}</div>`;
            } finally {
                rankingBtn.disabled = false;
                rankingBtn.textContent = 'ë­í‚¹ ì¡°íšŒ';
            }
        }

        // ì—”í„°í‚¤ë¡œ ê²€ìƒ‰ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì • (ì´ë¯¸ HTMLì—ì„œ ì²˜ë¦¬ë¨)
    </script>
</body>
</html>
